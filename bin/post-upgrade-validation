#!/usr/bin/env bash
# Post-Upgrade Validation Script
# Validates critical system components after package upgrades
# Integrates with issue tracking system

set -euo pipefail

# Configuration
CODEX_DIR="/home/jack/codex-sys"
ISSUES_DIR="${CODEX_DIR}/issues"
LOG_FILE="/var/log/post-upgrade-validation.log"
MONITOR_SCRIPT="/home/jack/Desktop/main/scripts/set_hyprland_monitors.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Track validation results
VALIDATION_PASSED=true
ISSUES_FOUND=()

log_message() {
    echo -e "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

create_issue() {
    local issue_type="$1"
    local issue_title="$2"
    local issue_description="$3"
    local timestamp=$(date +%Y%m%d%H%M%S)
    local issue_file="${ISSUES_DIR}/${issue_type}/${timestamp}_$(echo "$issue_title" | tr ' ' '_' | tr '[:upper:]' '[:lower:]').md"

    mkdir -p "${ISSUES_DIR}/${issue_type}"

    cat > "$issue_file" << EOF
# $issue_title

**Date**: $(date +"%Y-%m-%d %H:%M:%S")
**Type**: $issue_type
**Status**: active
**Severity**: high
**Component**: post-upgrade-validation

## Description
$issue_description

## System Information
- Kernel: $(uname -r)
- NVIDIA Driver: $(nvidia-smi --query-gpu=driver_version --format=csv,noheader 2>/dev/null || echo "N/A")
- Hyprland: $(hyprctl version 2>/dev/null | grep -oP 'Hyprland v\K[0-9.]+' || echo "N/A")

## Diagnostic Output
\`\`\`
$(journalctl -xe --no-pager | tail -50)
\`\`\`

## Resolution Steps
1. Check system logs: \`journalctl -xe\`
2. Verify package versions: \`pacman -Q linux nvidia-open hyprland\`
3. Try manual recovery steps documented below

## Recovery Attempted
- [ ] Automatic recovery attempted
- [ ] Manual intervention required

---
Generated by post-upgrade-validation
EOF

    log_message "${YELLOW}[ISSUE]${NC} Created issue: $issue_file"
}

validate_nvidia() {
    log_message "${GREEN}[CHECK]${NC} Validating NVIDIA driver..."

    if lsmod | grep -q nvidia; then
        log_message "${GREEN}[OK]${NC} NVIDIA kernel module loaded"
    else
        log_message "${RED}[FAIL]${NC} NVIDIA kernel module not loaded"
        VALIDATION_PASSED=false
        ISSUES_FOUND+=("nvidia_module")

        # Attempt recovery
        log_message "${YELLOW}[RECOVERY]${NC} Attempting to load NVIDIA module..."
        if sudo modprobe nvidia; then
            log_message "${GREEN}[OK]${NC} NVIDIA module loaded successfully"
        else
            create_issue "crashes" "NVIDIA Module Load Failure" "NVIDIA kernel module failed to load after system upgrade. This typically indicates a kernel/driver version mismatch."
        fi
    fi

    if command -v nvidia-smi &>/dev/null && nvidia-smi &>/dev/null; then
        log_message "${GREEN}[OK]${NC} nvidia-smi functional"
    else
        log_message "${RED}[FAIL]${NC} nvidia-smi not working"
        VALIDATION_PASSED=false
        ISSUES_FOUND+=("nvidia_smi")
    fi
}

validate_cuda() {
    log_message "${GREEN}[CHECK]${NC} Validating CUDA installation..."

    if [[ -d /opt/cuda ]]; then
        if [[ -x /opt/cuda/bin/nvcc ]]; then
            CUDA_VERSION=$(/opt/cuda/bin/nvcc --version | grep -oP 'release \K[0-9.]+' | head -1)
            log_message "${GREEN}[OK]${NC} CUDA $CUDA_VERSION found and accessible"
        else
            log_message "${YELLOW}[WARN]${NC} CUDA directory exists but nvcc not executable"
            ISSUES_FOUND+=("cuda_nvcc")
        fi
    else
        log_message "${YELLOW}[WARN]${NC} CUDA not installed at /opt/cuda"
    fi
}

validate_hyprland() {
    log_message "${GREEN}[CHECK]${NC} Validating Hyprland compositor..."

    if pgrep -x Hyprland > /dev/null; then
        log_message "${GREEN}[OK]${NC} Hyprland process is running"

        # Check if hyprctl works
        if hyprctl version &>/dev/null; then
            log_message "${GREEN}[OK]${NC} hyprctl responsive"
        else
            log_message "${RED}[FAIL]${NC} hyprctl not responding"
            VALIDATION_PASSED=false
            ISSUES_FOUND+=("hyprctl")
            create_issue "bugs" "Hyprland Control Unresponsive" "hyprctl commands failing after upgrade. Compositor may need restart."
        fi
    else
        log_message "${YELLOW}[INFO]${NC} Hyprland not running (may be normal if not in session)"
    fi
}

validate_monitors() {
    log_message "${GREEN}[CHECK]${NC} Validating monitor configuration..."

    if [[ -f "$MONITOR_SCRIPT" ]]; then
        # Count connected monitors
        if command -v hyprctl &>/dev/null; then
            MONITOR_COUNT=$(hyprctl monitors 2>/dev/null | grep -c "Monitor" || echo "0")
            log_message "${GREEN}[INFO]${NC} Detected $MONITOR_COUNT monitor(s)"

            if [[ $MONITOR_COUNT -eq 4 ]]; then
                log_message "${GREEN}[OK]${NC} All 4 monitors detected"
            elif [[ $MONITOR_COUNT -gt 0 ]]; then
                log_message "${YELLOW}[WARN]${NC} Expected 4 monitors, found $MONITOR_COUNT"
                log_message "${YELLOW}[RECOVERY]${NC} Applying monitor configuration..."
                if bash "$MONITOR_SCRIPT"; then
                    log_message "${GREEN}[OK]${NC} Monitor configuration applied"
                else
                    log_message "${RED}[FAIL]${NC} Monitor configuration failed"
                    ISSUES_FOUND+=("monitors")
                fi
            fi
        fi
    fi
}

validate_critical_services() {
    log_message "${GREEN}[CHECK]${NC} Validating critical services..."

    CRITICAL_SERVICES=(
        "NetworkManager"
        "systemd-resolved"
    )

    for service in "${CRITICAL_SERVICES[@]}"; do
        if systemctl is-active "$service" &>/dev/null; then
            log_message "${GREEN}[OK]${NC} $service is active"
        else
            log_message "${RED}[FAIL]${NC} $service is not active"
            VALIDATION_PASSED=false

            # Attempt to restart
            log_message "${YELLOW}[RECOVERY]${NC} Attempting to restart $service..."
            if sudo systemctl restart "$service"; then
                log_message "${GREEN}[OK]${NC} $service restarted successfully"
            else
                log_message "${RED}[FAIL]${NC} Failed to restart $service"
                create_issue "crashes" "Service Failure: $service" "Critical service $service failed to start after system upgrade."
            fi
        fi
    done
}

check_disk_space() {
    log_message "${GREEN}[CHECK]${NC} Checking disk space..."

    USED_PERCENT=$(df / | awk 'NR==2 {print int($5)}')
    if [[ $USED_PERCENT -gt 90 ]]; then
        log_message "${YELLOW}[WARN]${NC} Root filesystem is ${USED_PERCENT}% full"

        # Clean package cache if needed
        if [[ $USED_PERCENT -gt 95 ]]; then
            log_message "${YELLOW}[RECOVERY]${NC} Cleaning package cache..."
            sudo paccache -rk2
            log_message "${GREEN}[OK]${NC} Package cache cleaned"
        fi
    else
        log_message "${GREEN}[OK]${NC} Disk usage at ${USED_PERCENT}%"
    fi
}

main() {
    log_message "════════════════════════════════════════"
    log_message "Post-Upgrade Validation Started"
    log_message "════════════════════════════════════════"

    # Run all validation checks
    validate_nvidia
    validate_cuda
    validate_hyprland
    validate_monitors
    validate_critical_services
    check_disk_space

    # Summary
    log_message "════════════════════════════════════════"
    if [[ "$VALIDATION_PASSED" == true ]]; then
        log_message "${GREEN}[PASS]${NC} All validation checks passed!"
    else
        log_message "${RED}[FAIL]${NC} Some validation checks failed!"
        log_message "Issues found: ${ISSUES_FOUND[*]}"
    fi

    # Update issue index if any issues were created
    if [[ ${#ISSUES_FOUND[@]} -gt 0 ]]; then
        log_message "${YELLOW}[INFO]${NC} Updating issue index..."
        echo "" >> "${ISSUES_DIR}/INDEX.md"
        echo "## Post-Upgrade Issues - $(date +%Y-%m-%d)" >> "${ISSUES_DIR}/INDEX.md"
        for issue in "${ISSUES_FOUND[@]}"; do
            echo "- $issue" >> "${ISSUES_DIR}/INDEX.md"
        done
    fi

    log_message "Validation complete. Log saved to: $LOG_FILE"
    log_message "════════════════════════════════════════"

    # Exit with appropriate code
    [[ "$VALIDATION_PASSED" == true ]] && exit 0 || exit 1
}

# Run main function
main "$@"